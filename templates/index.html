<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <script src="/static/js/socket.io-0.9.16.js"></script>
    <script src="/static/js/rssi.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">

    <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>


    <script type="text/javascript" charset="utf-8">
        var socket = io.connect('http://' + document.domain + ':' + location.port);
        var chat_ns = socket.of("/chat");

        var visitor_template = fmt(
                '<tr data-user-id="#{id}"> <td>#{username}</td> </tr>'
        );

        var message_template = fmt(
                '<p data-user-id="#{id}"> <b>#{username}</b>: #{msg}</p>'
        );
        chat_ns.on('connect', function () {
                }
        );

        chat_ns.on('client_connected', function (msg) {
                    console.log("connected", msg);
                    chat_ns.emit("client_list");
                }
        );

        chat_ns.on('client_list', function (msg) {
            console.log("list", msg);

            $("#visitors tbody > *").remove();

            var clients = msg['clients'];
            for (var i in clients) {
                if (clients.hasOwnProperty(i)) {
                    $("#visitors tbody").append(visitor_template({"username": clients[i], "id": i}))
                }
            }
        });
        chat_ns.on('client_joined', function (msg) {
                    console.log("joined", msg);
                    $("#visitors tbody").append(visitor_template(msg))
                }
        );
        chat_ns.on('client_leaved', function (msg) {
                    console.log("leaved", msg);
                    $("tr[data-user-id='" + msg.id + "']").remove()
                }
        );

        chat_ns.on("message", function (msg) {
            console.log("recive message", msg);
            $("#chat").append(message_template(msg))

        });

        $(function () {
            $("input").keypress(function (e) {
                if (e.keyCode == 13) {
                    console.log("send_message", this.value);
                    chat_ns.emit("message", this.value);
                    this.value = "";
                }
            });

        });

    </script>
</head>
<body>

<div class="container">
    <div class="row">
        <div class="col-md-5">
            <div class="panel panel-default">
                <div class="panel-heading">Chat</div>
                <div id="chat" class="panel-body" style="height: 500px; overflow-y: auto">

                </div>
            </div>
            <div>
                <div class="form-group">
                    <input type="text" class="form-control" id="chat-input">
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="panel panel-default">
                <div class="panel-heading">Visitors</div>
                <div class="panel-body" style="height: 500px">
                    <table id="visitors">
                        <tbody>
                        </tbody>
                    </table>

                </div>
            </div>

        </div>
    </div>
</div>

</body>
</html>